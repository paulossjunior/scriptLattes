name: Scheduled Lattes Update

on:
  schedule:
    # Executa a cada 15 dias Ã s 02:00 UTC (23:00 horÃ¡rio de BrasÃ­lia no horÃ¡rio padrÃ£o)
    - cron: '0 2 */15 * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  update-lattes-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: Download and setup ChromeDriver
      run: |
        # Get Chrome version
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
        echo "Chrome version: $CHROME_VERSION"
        
        # Download corresponding ChromeDriver
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        CHROMEDRIVER_URL="https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json"
        CHROMEDRIVER_VERSION=$(curl -s $CHROMEDRIVER_URL | jq -r ".versions[] | select(.version | startswith(\"$CHROME_MAJOR_VERSION.\")) | .version" | sort -V | tail -1)
        
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        # Download and setup ChromeDriver
        wget -O chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"
        unzip chromedriver.zip
        chmod +x chromedriver-linux64/chromedriver
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        rm -rf chromedriver.zip chromedriver-linux64/
        
        # Verify installation
        chromedriver --version
        
    - name: Run scriptLattes
      run: |
        python scriptLattes.py ./exemplo/teste-01.config
        
    - name: Check generated files
      run: |
        echo "Generated files:"
        find ./exemplo/teste-01 -type f -name "*.json" | head -10
        find ./exemplo/teste-01 -type f -name "*.html" | head -5
        
        echo "JSON file sizes:"
        ls -lh ./exemplo/teste-01/json/*.json 2>/dev/null || echo "No JSON files found"
        
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lattes-data-${{ github.run_number }}
        path: |
          ./exemplo/teste-01/*.html
          ./exemplo/teste-01/json/*.json
          ./exemplo/teste-01/*.csv
          ./exemplo/teste-01/*.gexf
        retention-days: 30
        
    - name: Commit and push all generated files
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all generated files
        git add ./exemplo/teste-01/
        
        # Check if there are changes to commit
        if [[ -n $(git status --porcelain) ]]; then
          git commit -m "ðŸ¤– Auto-update Lattes data - $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ðŸ“Š Generated files:
          - HTML reports with interactive tables and graphs
          - Individual JSON files for each researcher
          - CSV data exports and collaboration graphs
          - Updated cache and processed data
          
          ðŸ”„ Automated execution every 15 days"
          git push
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}